version: 1

deploy:
  steps:
    setupVariables:
      after: &login-k8s
        - aws eks --region=$AWS_DEFAULT_REGION update-kubeconfig --name 
        - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        - chmod 700 get_helm.sh
        - ./get_helm.sh
        - helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        - helm install prometheus prometheus-community/kube-prometheus-stack --namespace monitoring --create-namespace --set alertmanager.persistentVolume.storageClass="gp2",server.persistentVolume.storageClass="gp2"

destroy:
  steps:
    setupVariables:
      after: *login-k8s